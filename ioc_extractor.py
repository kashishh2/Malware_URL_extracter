import pefile
import re
import ghidra.app.script.GhidraScript as GhidraScript
import ghidra.program.model.listing.Function as Function

# Define regular expression patterns to match URLs and IPs
url_pattern = re.compile(r'https?://(?:[-\w.]|(?:%[\da-fA-F]{2}))+')
ip_pattern = re.compile(r'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}')


pe = pefile.PE('/Users/kashishhanda/Documents/Code works/Malware_URL_extracter/sample_malware.exe')

# When an executable is compiled, the compiler will divide the resulting binary into multiple sections. 
# Each section has a specific role and is designated for a certain type of data or code, such as:

# .text section: contains executable code that the program uses.
# .data section: contains global and static data that is initialized before the program runs.
# .rsrc section: contains resources used by the program such as icons, images, or sound files.

# Sections are often identified by names or labels, such as .text, .data, or .rsrc, which correspond 
# to the function of the section in the executable. By understanding the sections in an executable, 
# one can gain insight into the inner workings of the program and potentially discover vulnerabilities 
# or other useful information.

with open('urls_and_ips.txt', 'w') as file:
    # Iterate through the sections in the file and search for URLs and IPs
    for section in pe.sections:
        data = section.get_data()
        urls = url_pattern.findall(data.decode('utf-8', errors='ignore'))
        ips = ip_pattern.findall(data.decode('utf-8', errors='ignore'))
        if urls or ips:
            print(f'Found {len(urls)} URLs and {len(ips)} IPs in section {section.Name}:\n')
            file.write(f'Found {len(urls)} URLs and {len(ips)} IPs in section {section.Name}:\n')
            if urls:
                file.write('URLs:\n')
                for url in urls:
                    print(url)
                    file.write(url + '\n')
            if ips:
                file.write('IPs:\n')
                for ip in ips:
                    print(ip)
                    file.write(ip + '\n')
        else:
            file.write(f'No URLs or IPs found in section {section.Name}\n')
            print(f'No URLs or IPs found in section {section.Name}\n')

pe.close()

class ListFunctions(GhidraScript):
    def run(self):
        # Get the current program
        currentProgram = self.getCurrentProgram()

        # Iterate over all functions in the program and print their names
        for function in currentProgram.getFunctionManager().getFunctions(True):
            self.println(function.getName())

# Create a new instance of the script and run it
ListFunctions().run()

